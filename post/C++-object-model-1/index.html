<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C++å¯¹è±¡æ¨¡å‹å®ä¾‹åˆ†æ | YANG&#39;s Blog</title>
<link rel="shortcut icon" href="https://yang2096.github.io/favicon.ico?v=1679122420367">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://yang2096.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="C++å¯¹è±¡æ¨¡å‹å®ä¾‹åˆ†æ | YANG&#39;s Blog - Atom Feed" href="https://yang2096.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="C++ å¤šæ€çš„åº•å±‚æ”¯æŒ
C++ ä¸­ä½¿ç”¨éæŒ‡é’ˆï¼Œéå¼•ç”¨çš„å¯¹è±¡æ¥è°ƒç”¨å‡½æ•°æ—¶ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µå…¶è°ƒç”¨çš„å‡½æ•°åœ°å€å°±å·²ç»ç¡®å®šä¸‹æ¥ï¼Œæ²¡æœ‰ï¼ˆä¹Ÿä¸éœ€è¦ï¼‰åŠ¨æ€ç»‘å®šçš„æ•ˆæœã€‚å³ä½¿æ˜¯å¤šä¸ªé‡åå‡½æ•°ï¼Œä¹Ÿå¯ä»¥ç»è¿‡å‡½æ•°åŒ¹é…ç¡®å®šä¸ºå…¶ä¸­ä¸€ä¸ªï¼Œå³é™æ€å¤šæ€ã€‚
æ­¤æ—¶å¯¹è±¡çš„æ•°æ®å’Œå‡½æ•°å…¶å®æ˜¯..." />
    <meta name="keywords" content="C++" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://yang2096.github.io">
  <img class="avatar" src="https://yang2096.github.io/images/avatar.png?v=1679122420367" alt="">
  </a>
  <h1 class="site-title">
    YANG&#39;s Blog
  </h1>
  <p class="site-description">
    Yet ANother Good blog
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="https://yang2096.github.io/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
        <a href="https://github.com/yang2096" target="_blank">
          <i class="ri-github-line"></i>
        </a>
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              C++å¯¹è±¡æ¨¡å‹å®ä¾‹åˆ†æ
            </h2>
            <div class="post-info">
              <span>
                2020-06-13
              </span>
              <span>
                29 min read
              </span>
              
                <a href="https://yang2096.github.io/tag/c++/" class="post-tag">
                  # C++
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://yang2096.github.io/post-images/C++-object-model-1.png" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <h2 id="c-å¤šæ€çš„åº•å±‚æ”¯æŒ">C++ å¤šæ€çš„åº•å±‚æ”¯æŒ</h2>
<p>C++ ä¸­ä½¿ç”¨éæŒ‡é’ˆï¼Œéå¼•ç”¨çš„å¯¹è±¡æ¥è°ƒç”¨å‡½æ•°æ—¶ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µå…¶è°ƒç”¨çš„å‡½æ•°åœ°å€å°±å·²ç»ç¡®å®šä¸‹æ¥ï¼Œæ²¡æœ‰ï¼ˆä¹Ÿä¸éœ€è¦ï¼‰åŠ¨æ€ç»‘å®šçš„æ•ˆæœã€‚å³ä½¿æ˜¯å¤šä¸ªé‡åå‡½æ•°ï¼Œä¹Ÿå¯ä»¥ç»è¿‡å‡½æ•°åŒ¹é…ç¡®å®šä¸ºå…¶ä¸­ä¸€ä¸ªï¼Œå³é™æ€å¤šæ€ã€‚</p>
<p>æ­¤æ—¶å¯¹è±¡çš„æ•°æ®å’Œå‡½æ•°å…¶å®æ˜¯â€åˆ†è£‚â€œçš„ï¼Œå¯¹è±¡æ‰€åœ¨çš„å†…å­˜å½“ä¸­æ²¡æœ‰å…³äºç±»å‹ä»¥åŠæ‰€å±å‡½æ•°çš„ä¿¡æ¯ã€‚</p>
<p>é€šè¿‡çˆ¶ç±»çš„æŒ‡é’ˆæˆ–å¼•ç”¨æ¥è°ƒç”¨è™šå‡½æ•°ï¼Œèƒ½è°ƒç”¨åˆ°å­ç±»å¯¹è±¡å®é™…ä¸Šå®ç°çš„å‡½æ•°ï¼Œå³å­ç±»ä¸­é‡å†™çš„è™šå‡½æ•°ã€‚è¿™å°±æ˜¯åŠ¨æ€å¤šæ€ã€‚è€Œè¦å®ç°å»¶è¿Ÿç»‘å®šï¼Œéœ€è¦ç±»çš„ç±»å‹ä¿¡æ¯ä¸å¯¹è±¡çš„æ•°æ®â€åŒæ­¥â€œå­˜åœ¨ã€‚å³å¯ä»¥é€šè¿‡æ£€æŸ¥å¯¹è±¡æ•°æ®ä¸­çš„æŸä¸ªå­—æ®µï¼Œå¾—åˆ°æ•´å—å†…å­˜çš„ç±»å‹ä¿¡æ¯ã€‚</p>
<p>å› æ­¤ C++ ä¸­å¼•å…¥äº†è™šå‡½æ•°è¡¨æ¥æŒ‡æ˜å¯¹è±¡çš„ç±»å‹ã€å…³è”æ‰€å±çš„å‡½æ•°ã€‚é€šè¿‡åœ¨å¯¹è±¡ä¸­æ”¾ç½®è™šå‡½æ•°è¡¨æŒ‡é’ˆ <code>vptr</code> æ¥å…³è”å†…å­˜ä¸ç±»å‹ã€‚åœ¨è¿è¡Œæ—¶é€šè¿‡è¯»å–è™šè¡¨ä¸­çš„å†…å®¹ï¼Œæ¥å®ç°å¤šæ€æ€§ã€‚</p>
<p>æœ¬æ–‡é€šè¿‡åˆ†æä¸€äº›ç®€å•çš„ä¾‹å­ï¼Œå°è¯•è§£é‡Šè¿™ä¸€æ•´å¥—æµç¨‹ã€‚</p>
<h2 id="è™šå‡½æ•°è¡¨çš„åŸºæœ¬ç»“æ„">è™šå‡½æ•°è¡¨çš„åŸºæœ¬ç»“æ„</h2>
<h3 id="æœ€åŸºç¡€çš„æƒ…å†µ">æœ€åŸºç¡€çš„æƒ…å†µ</h3>
<p>æœ€åŸºç¡€çš„æƒ…å†µå°±æ˜¯å•ç»§æ‰¿ï¼Œæ²¡æœ‰è™šç»§æ‰¿çš„æƒ…å†µã€‚</p>
<pre><code class="language-c++">#include &lt;iostream&gt;
using namespace std;

class B
{
public:
    int ib;
    char cb;

    B() : ib(0xBB), cb('A') {}
    virtual void f()  { ++ib; cout &lt;&lt; &quot;B::f()&quot; &lt;&lt; endl; }
    virtual void Bf() { --ib; cout &lt;&lt; &quot;B::Bf()&quot; &lt;&lt; endl; }
};

class D : public B
{
public:
    int id;
    char cd;

    D() : id(0xDD), cd('D') {}
    virtual void f()  { ++cb; cout &lt;&lt; &quot;D::f()&quot; &lt;&lt; endl; }
    virtual void Df() { --cb; cout &lt;&lt; &quot;D::Df()&quot; &lt;&lt; endl; }
};

int main()
{
    D d;
    B * b_ptr = &amp;d;
    d.Bf();
    b_ptr-&gt;Bf();
}
</code></pre>
<p>åœ¨ g++ ä¸­ä½¿ç”¨ <code>-fdump-class-hierarchy</code> æˆ–è€… <code>-fdump-lang-class</code> é€‰é¡¹ï¼Œåˆæˆ–è€…åœ¨ VisualStudio çš„ <code>é¡¹ç›® -&gt; å±æ€§ -&gt; é…ç½®å±æ€§ -&gt; C/C++ -&gt; å‘½ä»¤è¡Œ -&gt; å…¶ä»–é€‰é¡¹</code> ä¸­æ·»åŠ é€‰é¡¹ <code>/d1reportAllClassLayout</code> å¯ä»¥å¯¼å‡ºå¯¹è±¡çš„è™šå‡½æ•°è¡¨ç»“æ„ã€‚</p>
<p>è¿™é‡Œæˆ‘ç”¨çš„ g++ ç‰ˆæœ¬æ˜¯ gcc version 7.5.0 (Ubuntu 7.5.0-3ubuntu1~18.04) ï¼Œé€šè¿‡<br>
<code>g++ -g -o single ./single_hierarchy.cpp -fdump-class-hierarchy</code><br>
å¾—åˆ°ä¸Šè¿°ä¸¤ä¸ªç±»çš„è™šå‡½æ•°è¡¨å’Œå¯¹è±¡å†…å­˜å¸ƒå±€ï¼Œå†ç»è¿‡ <code>c++filt</code> è¿›è¡Œ <code>demangle</code> å¾—åˆ°æ˜“äºé˜…è¯»çš„ç¬¦å·åç§°ã€‚</p>
<h4 id="è™šè¡¨å¸ƒå±€">è™šè¡¨å¸ƒå±€</h4>
<pre><code>Vtable for B
B::vtable for B: 4 entries
0     (int (*)(...))0
8     (int (*)(...))(&amp; typeinfo for B)
16    (int (*)(...))B::f
24    (int (*)(...))B::Bf

Class B
   size=16 align=8
   base size=13 base align=8
B (0x0x7f3d6ce36720) 0
    vptr=((&amp; B::vtable for B) + 16)

Vtable for D
D::vtable for D: 5 entries
0     (int (*)(...))0
8     (int (*)(...))(&amp; typeinfo for D)
16    (int (*)(...))D::f
24    (int (*)(...))B::Bf
32    (int (*)(...))D::Df

Class D
   size=24 align=8
   base size=21 base align=8
D (0x0x7f3d6ce6f958) 0
    vptr=((&amp; D::vtable for D) + 16)
  B (0x0x7f3d6ce76660) 0
      primary-for D (0x0x7f3d6ce6f958)
</code></pre>
<p>å†ç»“åˆ<code>gdb</code>æ¥æŸ¥çœ‹å®é™…ç¨‹åºä¸­çš„å†…å­˜å¸ƒå±€ï¼š</p>
<pre><code class="language-c++">(gdb) info locals
d = {&lt;B&gt; = {_vptr.B = 0x8201d28 &lt;vtable for D+16&gt;, ib = 187, cb = 65 'A'}, id = 221, cd = 68 'D'}
b_ptr = 0x7ffffffee180
(gdb) x/3xg &amp;d
0x7ffffffee180: 0x0000000008201d28      0x00000041000000b9
0x7ffffffee190: 0x00007f44000000dd
(gdb) x/5xg 0x8201d18
0x8201d18 &lt;_ZTV1D&gt;:     0x0000000000000000      0x0000000008201d60
0x8201d28 &lt;_ZTV1D+16&gt;:  0x0000000008000caa      0x0000000008000c26
0x8201d38 &lt;_ZTV1D+32&gt;:  0x0000000008000cf2
</code></pre>
<p>è¿™é‡ŒæŸ¥çœ‹å¯¹è±¡ d çš„å†…å­˜å¸ƒå±€ <code>x/3xg &amp;d</code> ä¸­çš„ 3 æ˜¯ä»ç±» D çš„å¤§å°ï¼ˆ24/8ï¼‰å¾—åˆ°ã€‚<br>
æŸ¥çœ‹è™šå‡½æ•°è¡¨çš„å¸ƒå±€ <code>x/5xg 0x8201d18</code> ä¸­çš„ 5 æ˜¯ä» <code>D::vtable for D: 5 entries</code> è¿™é‡Œçœ‹åˆ°æœ‰ 5 ä¸ªè¡¨é¡¹ï¼Œ <code>0x8201d18</code> åˆ™æ˜¯ <code>_vptr.B = 0x8201d28</code> å‡å»åç§» 16 å¾—åˆ°ã€‚</p>
<p>é€šè¿‡ <code>nm -Cn ./single</code> å¾—åˆ°ç¬¦å·çš„åœ°å€ä¿¡æ¯</p>
<pre><code>// ä»…å±•ç¤ºç›¸å…³éƒ¨åˆ†
...
0000000000000bb2 W B::B()
0000000000000bb2 W B::B()
0000000000000bde W B::f()
0000000000000c26 W B::Bf()
0000000000000c6e W D::D()
0000000000000c6e W D::D()
0000000000000caa W D::f()
0000000000000cf2 W D::Df()
...
0000000000201d18 V vtable for D
0000000000201d40 V vtable for B
0000000000201d60 V typeinfo for D
0000000000201d78 V typeinfo for B
...

</code></pre>
<p>å¯ä»¥çœ‹åˆ°å¯¹è±¡ d ä¸­èµ·å§‹ä½ç½®å­˜å‚¨çš„æ˜¯ <code>vptr</code>ï¼ŒæŒ‡å‘äº†ç±» D çš„ vtable + 16  <code>0x0000000008201d28</code>ã€‚<br>
è¿™é‡Œä¸ <code>nm</code> å‘½ä»¤å¯¼å‡ºçš„åœ°å€ä¿¡æ¯ç›¸å·®äº† <code>0x8000000</code>ï¼Œæˆ‘æƒ³åº”è¯¥æ˜¯ <code>nm</code> ä¸­ç»™å‡ºçš„åœ°å€æ˜¯æ®µå†…åç§»ï¼Œè€Œ <code>.text</code> æ®µçš„å¼€å§‹åœ°å€æ˜¯<code>0x8000000</code>ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸Šè¿™ä¹ˆå¤šæ¥å¾—åˆ°è¿è¡Œæ—¶çš„ç»å¯¹åœ°å€ã€‚å¯ä»¥æŸ¥çœ‹è¿›ç¨‹çš„ <code>mmap</code> ä¿¡æ¯ç¡®è®¤ã€‚</p>
<p>ç»§ç»­æŸ¥çœ‹ç±» D çš„ vtableï¼Œå‘ç°å…¶ä¸­å­˜å‚¨çš„ä¿¡æ¯ç¡®å®ä¸<code>g++</code>å¯¼å‡ºçš„å¸ƒå±€ä¸€ä¸€å¯¹åº”ã€‚<br>
è¿™é‡Œå¯ä»¥çœ‹å‡ºå¯¹è±¡å†…éƒ¨çš„ <code>vptr</code> å¹¶ä¸æ˜¯æŒ‡å‘è™šå‡½æ•°è¡¨çš„èµ·å§‹ä½ç½®ï¼Œè€Œæ˜¯è¶Šè¿‡äº†å¼€å¤´çš„ä¸¤é¡¹ã€‚<br>
ç¬¬äºŒé¡¹ä»åå­—ä¸Šå°±å¯ä»¥çœ‹å‡ºæŒ‡å‘çš„æ˜¯ç±»çš„ç±»å‹ä¿¡æ¯ã€‚é‚£ä¹ˆç¬¬ä¸€é¡¹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä»è¿™ä¸ªç®€å•çš„æ ·ä¾‹è¿˜çœ‹ä¸å‡ºæ‰€ä»¥ç„¶æ¥ï¼Œä¸è¿‡ä»å…¶ä»–èµ„æ–™å¯çŸ¥ï¼Œè™šå‡½æ•°è¡¨çš„ç¬¬ä¸€é¡¹æ˜¯ç”¨æ¥æŒ‡æ˜ç»§æ‰¿ä½“ç³»ä¸­ä¸åŒç±»å‹çš„æŒ‡é’ˆæŒ‡å‘å½“å‰å¯¹è±¡å®ä¾‹æ—¶ï¼Œ<code>this</code> æŒ‡é’ˆä¸å¯¹è±¡çš„èµ·å§‹ä½ç½®ä¹‹é—´çš„åç§»ã€‚ä¸€ä¸ªæ´¾ç”Ÿç±»é€šè¿‡åˆæ³•çš„å‘ä¸Šè½¬å‹æˆä¸åŒçš„çˆ¶ç±»æˆ–ç¥–ç±»æŒ‡é’ˆåï¼Œè¿™äº›æŒ‡é’ˆæŒ‡å‘çš„å…¶å®æ˜¯å¯¹è±¡å®ä¾‹çš„ä¸åŒéƒ¨åˆ†ã€‚</p>
<h4 id="è™šè¡¨æŒ‡é’ˆåˆè¯•é”‹èŠ’">è™šè¡¨æŒ‡é’ˆåˆè¯•é”‹èŠ’</h4>
<p>å°†ä¸Šè¿°ä»£ç è¾“å…¥åˆ°<a href="https://godbolt.org/">è¿™ä¸ªç½‘ç«™</a>å¯ä»¥è§‚å¯Ÿåˆ°ç¼–è¯‘åçš„æ±‡ç¼–ä»£ç ã€‚<br>
<img src="https://yang2096.github.io/post-images/1629730271727.png" alt="" loading="lazy"><br>
<code>d.Bf();</code> è¿™æ¡è¯­å¥æ˜¯ä½¿ç”¨å¯¹è±¡ç›´æ¥è°ƒç”¨è™šå‡½æ•°ï¼Œåœ¨æ±‡ç¼–ä»£ç çš„ç¬¬ 123 è¡Œå¯ä»¥çœ‹å‡ºåœ¨ç¼–è¯‘æœŸå°±ç¡®å®šäº†æ˜¯ç›´æ¥è°ƒç”¨å‡½æ•° <code>B::Bf()</code>ã€‚è€Œåä¸€æ¡è¯­å¥<code>b_ptr-&gt;Bf();</code>é€šè¿‡æŒ‡é’ˆæ¥è°ƒç”¨è™šå‡½æ•°æ—¶ï¼Œåˆ™å¤šå‡ºäº†å‡ æ­¥ï¼š</p>
<pre><code class="language-asm">mov     rax, QWORD PTR [rbp-8]      // b_ptr çš„æ•°å€¼
mov     rax, QWORD PTR [rax]        // è·å–è™šå‡½æ•°è¡¨çš„åœ°å€ï¼ˆè·³è¿‡å‰ä¸¤é¡¹ï¼‰
add     rax, 8                      // ç¬¬äºŒä¸ªå‡½æ•°è¡¨é¡¹çš„åœ°å€ï¼ˆå®é™…æ˜¯ç¬¬å››é¡¹ï¼‰
mov     rax, QWORD PTR [rax]        // è™šå‡½æ•° B::Bf() çš„åœ°å€
mov     rdx, QWORD PTR [rbp-8]      // this ä½œä¸ºå‚æ•°
mov     rdi, rdx
call    rax                         // è°ƒç”¨ B::Bf()
</code></pre>
<p>è¿™å°±æ˜¯è™šè¡¨æŒ‡é’ˆå‘æŒ¥ä½œç”¨çš„æ—¶åˆ»ä¹‹ä¸€ï¼ŒåŠ¨æ€ç»‘å®šæ‰€è¿è¡Œçš„å‡½æ•°ã€‚</p>
<h3 id="å¤šç»§æ‰¿çš„æƒ…å†µ">å¤šç»§æ‰¿çš„æƒ…å†µ</h3>
<p>ç±» C åŒæ—¶ç»§æ‰¿ç±» A å’Œç±» B</p>
<pre><code class="language-c++">#include &lt;string&gt;
#include &lt;iostream&gt;
using namespace std;
class A {
public:
    int i1;
    char c1;

    A() : i1(0xAA), c1('A') {}
    virtual void f()  { cout &lt;&lt; &quot;A::f()&quot;  &lt;&lt; endl; }
    virtual void f1() { cout &lt;&lt; &quot;A::f1()&quot; &lt;&lt; endl; }
};

class B {
public:
    int i2;
    char c2;

    B() : i2(0xBB), c2('B') {}
    virtual void f()  { cout &lt;&lt; &quot;B::f()&quot; &lt;&lt; endl; }
    virtual void f2() { cout &lt;&lt; &quot;B::f2()&quot; &lt;&lt; endl; }
};

class C : public B, public A
{
public:
    int i3;
    char c3;
    C() : i3(0xCC), c3('C') {}
    virtual void f()  { cout &lt;&lt; &quot;C::f()&quot; &lt;&lt; endl; }
    virtual void f2() { cout &lt;&lt; &quot;C::f2()&quot; &lt;&lt; endl; }
};

int main(void)
{
    C c;
    C * c_ptr = &amp;c;
    B * b_ptr = &amp;c;
    A * a_ptr = &amp;c;

    cout &lt;&lt; &quot;c_ptr : &quot; &lt;&lt; c_ptr &lt;&lt; endl
         &lt;&lt; &quot;b_ptr : &quot; &lt;&lt; b_ptr &lt;&lt; endl
         &lt;&lt; &quot;a_ptr : &quot; &lt;&lt; a_ptr &lt;&lt; endl;

    long* data = (long *)* (long *)b_ptr;   
    cout &lt;&lt; hex &lt;&lt; data &lt;&lt; endl;

    typedef void(*Func)(void *);
    Func fun = (Func) data[0];
    fun(b_ptr);
}
</code></pre>
<h4 id="è™šè¡¨å¸ƒå±€-2">è™šè¡¨å¸ƒå±€</h4>
<pre><code class="language-c++">Vtable for A
A::vtable for A: 4 entries
0     (int (*)(...))0
8     (int (*)(...))(&amp; typeinfo for A)
16    (int (*)(...))A::f
24    (int (*)(...))A::f1

Class A
   size=16 align=8
   base size=13 base align=8
A (0x0x7f188fae6720) 0
    vptr=((&amp; A::vtable for A) + 16)

Vtable for B
B::vtable for B: 4 entries
0     (int (*)(...))0
8     (int (*)(...))(&amp; typeinfo for B)
16    (int (*)(...))B::f
24    (int (*)(...))B::f2

Class B
   size=16 align=8
   base size=13 base align=8
B (0x0x7f188fb25660) 0
    vptr=((&amp; B::vtable for B) + 16)

Vtable for C
C::vtable for C: 9 entries
0     (int (*)(...))0
8     (int (*)(...))(&amp; typeinfo for C)
16    (int (*)(...))C::f
24    (int (*)(...))C::f2
32    (int (*)(...))C::f3
40    (int (*)(...))-16
48    (int (*)(...))(&amp; typeinfo for C)
56    (int (*)(...))C::non-virtual thunk to C::f()
64    (int (*)(...))A::f1

Class C
   size=40 align=8
   base size=37 base align=8
C (0x0x7fefa3b89d20) 0
    vptr=((&amp; C::vtable for C) + 16)
  B (0x0x7fefa3b96900) 0
      primary-for C (0x0x7fefa3b89d20)
  A (0x0x7fefa3b96960) 16
      vptr=((&amp; C::vtable for C) + 56)
</code></pre>
<p>å†æ¥ç€çœ‹åˆ° <code>gdb</code> ä¸­è¯»å–å‡ºçš„å®é™…è¿è¡ŒæœŸæ•°æ®ï¼š</p>
<pre><code class="language-c++">// è¿è¡Œåˆ°äº†æœ€åä¸€è¡Œ
(gdb) info locals
c = {&lt;B&gt; = {_vptr.B = 0x8201ca0 &lt;vtable for C+16&gt;, i2 = 187, c2 = 66 'B'}, &lt;A&gt; = {_vptr.A = 0x8201cc8 &lt;vtable for C+56&gt;, i1 = 170, c1 = 65 'A'}, i3 = 204, c3 = 67 'C'}
c_ptr = 0x7ffffffeddf0
b_ptr = 0x7ffffffeddf0
a_ptr = 0x7ffffffede00
data = 0x8201ca0 &lt;vtable for C+16&gt;
fun = 0x800123d &lt;__libc_csu_init+77&gt;
(gdb) x/5xg &amp;c
0x7ffffffeddf0: 0x0000000008201ca0      0x00000042000000bb      // vtable for C+16       B::c2 B::i2
0x7ffffffede00: 0x0000000008201cc8      0x00000041000000aa      // vtable for C+56       A::c1 A::i1
0x7ffffffede10: 0x00007f43000000cc                              // C::c3 C::i3
(gdb) x/9xg data-2
0x8201c90 &lt;_ZTV1C&gt;:     0x0000000000000000      0x0000000008201d18  // 0                 &amp; typeinfo for C
0x8201ca0 &lt;_ZTV1C+16&gt;:  0x0000000008001126      0x0000000008001174  // C::f              C::f2
0x8201cb0 &lt;_ZTV1C+32&gt;:  0x00000000080011ac      0xfffffffffffffff0  // C::f3             -16
0x8201cc0 &lt;_ZTV1C+48&gt;:  0x0000000008201d18      0x000000000800116e  // &amp; typeinfo for C  C::non-virtual thunk to C::f()
0x8201cd0 &lt;_ZTV1C+64&gt;:  0x0000000008000ff6                          // A::f1
</code></pre>
<p>åŸºæœ¬ä¸Šå¯ä»¥çœ‹å‡ºï¼Œ<code>c</code> ä¸­æœ‰ä¸¤ä¸ªè™šè¡¨æŒ‡é’ˆ <code>vptr</code>, åˆ†åˆ«&quot;æœåŠ¡&quot;äºå®ƒçš„ä¸¤ä¸ªç›´æ¥åŸºç±»ã€‚å‘ä¸Šè½¬å‹åˆ°å“ªä¸ªç±»ï¼Œå…¶æŒ‡é’ˆå°±æŒ‡å‘åŸºç±»å®ä¾‹ä¸­å“ªä¸ª <code>vptr</code> çš„ä½ç½®ã€‚æ­¤ä¾‹ä¸­çš„ <code>a_ptr</code> å°±æŒ‡å‘äº†å¯¹è±¡<code>c</code>ä¸­ç¬¬äºŒä¸ª<code>vptr</code>çš„åœ°å€<code>0x7ffffffede00</code>ã€‚</p>
<p>ä¹‹å‰åˆ†æäº†è™šå‡½æ•°è°ƒç”¨æ—¶çš„æ±‡ç¼–ä»£ç ï¼ŒçŸ¥é“äº†è°ƒç”¨è™šå‡½æ•°æ˜¯ä¾é <code>vptr</code>çš„åç§»æ¥å®šä½çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åŸºç±»ä¸­çš„è™šå‡½æ•°å’Œæ´¾ç”Ÿç±»ä¸­é‡å†™çš„è™šå‡½æ•°åº”è¯¥æ˜¯ä½äºè™šè¡¨ä¸­çš„åŒä¸€ä½ç½®ã€‚æ‰€ä»¥åŸºç±»ä¸æ´¾ç”Ÿç±»ä¸¤è€…çš„è™šå‡½æ•°è¡¨ç»“æ„åº”è¯¥æ˜¯å¯ä»¥â€é‡å â€œä¸Šçš„ã€‚</p>
<p>å…·ä½“åˆ°å½“å‰è¿™ä¸ªä¾‹å­ï¼Œå¦‚æœå°†åŸºç±»å’Œæ´¾ç”Ÿç±»çš„è™šè¡¨è¿™æ ·æ”¾ç½®ï¼š</p>
<pre><code>C::vtable for C: 9 entries                                  // B çš„è™šè¡¨
0     (int (*)(...))0                                       0     (int (*)(...))0
8     (int (*)(...))(&amp; typeinfo for C)                      8     (int (*)(...))(&amp; typeinfo for B)
16    (int (*)(...))C::f                                    16    (int (*)(...))B::f
24    (int (*)(...))C::f2                                   24    (int (*)(...))B::f2
32    (int (*)(...))C::f3                                   // A çš„è™šè¡¨
40    (int (*)(...))-16                                     0     (int (*)(...))0
48    (int (*)(...))(&amp; typeinfo for C)                      8     (int (*)(...))(&amp; typeinfo for A)
56    (int (*)(...))C::non-virtual thunk to C::f()          16    (int (*)(...))A::f
64    (int (*)(...))A::f1                                   24    (int (*)(...))A::f1
</code></pre>
<p>å¯ä»¥çœ‹å‡ºï¼Œé™¤äº†æ´¾ç”Ÿç±»ä¸­æ–°å¢çš„è™šå‡½æ•°è¢«è¿½åŠ åˆ°å±äºç¬¬ä¸€ä¸ªåŸºç±»çš„è™šå‡½æ•°è¡¨å°¾éƒ¨ï¼Œå·¦å³å…¶ä»–éƒ¨åˆ†çš„è¡¨é¡¹éƒ½æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚æ´¾ç”Ÿç±»ä¸­é‡å†™çš„è™šå‡½æ•°â€œé¡¶æ›¿â€äº†åŸºç±»ä¸­åŸæ¥çš„è¡¨é¡¹ï¼Œæ²¡æœ‰é‡å†™çš„åˆ™ä¿æŒäº†åŸæ¥çš„å€¼ã€‚</p>
<p>å¦‚æœç»§æ‰¿çš„å±‚æ¬¡æ¯”è¾ƒå¤šçš„è¯ï¼Œè™šè¡¨çš„ç»“æ„ä¹Ÿæ˜¯ç”±ä¸Šè‡³ä¸‹ä¸€å±‚ä¸€å±‚â€œç»§æ‰¿â€è¿‡æ¥çš„ã€‚</p>
<p>è‡³æ­¤ï¼Œåœ¨ä¸æ¶‰åŠåˆ°è™šç»§æ‰¿çš„æƒ…å†µä¸‹ï¼Œè™šè¡¨çš„ç»“æ„ä»¥åŠå¯¹è±¡çš„ç»“æ„éƒ½ç®—æ˜¯æ¯”è¾ƒæ˜“å¾—çš„ã€‚å•ç»§æ‰¿æ—¶è™šè¡¨ç»“æ„â€œçˆ¶å­â€ç›¸æ‰¿ï¼Œå¤šç»§æ‰¿æ—¶æ— éå¤šå‡ ä¸ª <code>vptr</code>ã€‚å³ä¾¿æ˜¯å¤šé‡ç»§æ‰¿ï¼Œä»ä¸Šè‡³ä¸‹ç»†ç»†æ¨å¯¼ä¹Ÿä¸éš¾å¾—å‡ºæ‰€æœ‰çš„è™šè¡¨ç»“æ„ã€‚</p>
<p>é¡ºå¸¦ä¸€æè™šè¡¨ä¸­çš„<code>C::non-virtual thunk to C::f()</code>çš„ä½œç”¨æ˜¯å½“ä½¿ç”¨åŸºç±»æŒ‡é’ˆè®¿é—®å­ç±»ä¸­é‡å†™çš„è™šå‡½æ•°æ—¶ï¼Œå°†ä¼ å…¥çš„<code>this</code>æŒ‡é’ˆå‡å»åç§»åï¼Œå¾—åˆ°å¯¹è±¡çš„é¦–åœ°å€ï¼ˆæ´¾ç”Ÿç±»çš„<code>this</code>ï¼‰å†è°ƒç”¨è¯¥è™šå‡½æ•°ã€‚ä¸è¿‡è¿™é‡Œçš„åç§»æ˜¯ç¼–è¯‘æœŸå°±èƒ½ç¡®å®šçš„ä¸€ä¸ªå¸¸æ•°ï¼Œè€Œä¸æ˜¯ä½¿ç”¨<code>vptr - 2</code>ä½ç½®ä¸Šçš„åç§»å€¼ã€‚</p>
<h2 id="å¼•å…¥è™šç»§æ‰¿å¸¦æ¥çš„å˜åŒ–">å¼•å…¥è™šç»§æ‰¿å¸¦æ¥çš„å˜åŒ–</h2>
<p>è™šç»§æ‰¿ä¸€èˆ¬å¸¸è§äºé’»çŸ³å‹ç»§æ‰¿ç»“æ„ä¸­ã€‚</p>
<pre><code class="language-c++">// é’»çŸ³å‹è™šç»§æ‰¿
class B
{
public:
    int ib;
    char cb;

public:
    B() : ib(0xBB), cb('A') {}
    virtual void f() { ++ib; cout &lt;&lt; &quot;B::f()&quot; &lt;&lt; endl; }
    virtual void Bf() { --ib; cout &lt;&lt; &quot;B::Bf()&quot; &lt;&lt; endl; }
};

class B1 : virtual public B
{
public:
    int ib1;
    char cb1;

public:
    B1() : ib1(0xB1), cb1('B') {}
    virtual void f() { ++ib; cout &lt;&lt; &quot;B1::f()&quot; &lt;&lt; endl; }
    virtual void f1() { --cb; cout &lt;&lt; &quot;B1::f1()&quot; &lt;&lt; endl; }
    virtual void Bf1() { cout &lt;&lt; &quot;B1::Bf1()&quot; &lt;&lt; endl; }
};

class B2 : virtual public B
{
public:
    int ib2;
    char cb2;

public:
    B2() : ib2(0xB2), cb2('C') {}
    virtual void f() { ++ib; cout &lt;&lt; &quot;B2::f()&quot; &lt;&lt; endl; }
    virtual void f2() { --ib; cout &lt;&lt; &quot;B2::f2()&quot; &lt;&lt; endl; }
    virtual void Bf2() { cout &lt;&lt; &quot;B2::Bf2()&quot; &lt;&lt; endl; }
};

class D : public B1, public B2
{
public:
    int id;
    char cd;

public:
    D() : id(0xDD), cd('D') {}
    virtual void f() { ++ib; cout &lt;&lt; &quot;D::f()&quot; &lt;&lt; endl; }
    virtual void f1() { --ib; cout &lt;&lt; &quot;D::f1()&quot; &lt;&lt; endl; }
    virtual void f2() { cout &lt;&lt; &quot;D::f2()&quot; &lt;&lt; endl; }
    virtual void Df() { cout &lt;&lt; &quot;D::Df()&quot; &lt;&lt; endl; }
};

int main()
{
    D d;
    B1 * b1_ptr = &amp;d;
    B2 * b2_ptr = &amp;d;
    B * b_ptr = &amp;d;
    cout &lt;&lt; &quot;b_ptr : &quot; &lt;&lt; b_ptr &lt;&lt; endl
        &lt;&lt; &quot;b1_ptr : &quot; &lt;&lt; b1_ptr &lt;&lt; endl
        &lt;&lt; &quot;b2_ptr : &quot; &lt;&lt; b2_ptr &lt;&lt; endl
        &lt;&lt; &quot;d_ptr : &quot; &lt;&lt; &amp;d &lt;&lt; endl;
    cout &lt;&lt; typeid(*b1_ptr).name() &lt;&lt; endl;
    B1 b1;
    b_ptr = &amp;b1;
    b_ptr-&gt;Bf();
    b1_ptr = &amp;b1;
    b1_ptr-&gt;Bf();
}
</code></pre>
<p>ä¾æ—§æ˜¯å…ˆçœ‹è¿™äº›ç±»çš„å¸ƒå±€ï¼š</p>
<pre><code>Vtable for B
B::vtable for B: 4 entries
0     (int (*)(...))0
8     (int (*)(...))(&amp; typeinfo for B)
16    (int (*)(...))B::f
24    (int (*)(...))B::Bf

Class B
   size=16 align=8
   base size=13 base align=8
B (0x0x7ffad8f56720) 0
    vptr=((&amp; B::vtable for B) + 16)

Vtable for B1                                       Construction vtable for B1 (0x0x7ffad8f8fd00 instance) in D
B1::vtable for B1: 12 entries                       D::construction vtable for B1-in-D: 12 entries
0     16                                            0     40
8     (int (*)(...))0                               8     (int (*)(...))0
16    (int (*)(...))(&amp; typeinfo for B1)             16    (int (*)(...))(&amp; typeinfo for B1)
24    (int (*)(...))B1::f                           24    (int (*)(...))B1::f
32    (int (*)(...))B1::f1                          32    (int (*)(...))B1::f1
40    (int (*)(...))B1::Bf1                         40    (int (*)(...))B1::Bf1
48    0                                             48    0
56    18446744073709551600                          56    18446744073709551576
64    (int (*)(...))-16                             64    (int (*)(...))-40
72    (int (*)(...))(&amp; typeinfo for B1)             72    (int (*)(...))(&amp; typeinfo for B1)
80    (int (*)(...))B1::virtual thunk to B1::f()    80    (int (*)(...))B1::virtual thunk to B1::f()
88    (int (*)(...))B::Bf                           88    (int (*)(...))B::Bf

VTT for B1
B1::VTT for B1: 2 entries
0     ((&amp; B1::vtable for B1) + 24)
8     ((&amp; B1::vtable for B1) + 80)

Class B1
   size=32 align=8
   base size=13 base align=8
B1 (0x0x7ffad8f8f958) 0
    vptridx=0 vptr=((&amp; B1::vtable for B1) + 24)
  B (0x0x7ffad8f96660) 16 virtual
      vptridx=8 vbaseoffset=-24 vptr=((&amp; B1::vtable for B1) + 80)

Vtable for B2                                       Construction vtable for B2 (0x0x7ffad8f8fd68 instance) in D
B2::vtable for B2: 12 entries                       D::construction vtable for B2-in-D: 12 entries
0     16                                            0     24
8     (int (*)(...))0                               8     (int (*)(...))0
16    (int (*)(...))(&amp; typeinfo for B2)             16    (int (*)(...))(&amp; typeinfo for B2)
24    (int (*)(...))B2::f                           24    (int (*)(...))B2::f
32    (int (*)(...))B2::f2                          32    (int (*)(...))B2::f2
40    (int (*)(...))B2::Bf2                         40    (int (*)(...))B2::Bf2
48    0                                             48    0
56    18446744073709551600                          56    18446744073709551592
64    (int (*)(...))-16                             64    (int (*)(...))-24
72    (int (*)(...))(&amp; typeinfo for B2)             72    (int (*)(...))(&amp; typeinfo for B2)
80    (int (*)(...))B2::virtual thunk to B2::f()    80    (int (*)(...))B2::virtual thunk to B2::f()
88    (int (*)(...))B::Bf                           88    (int (*)(...))B::Bf

VTT for B2
B2::VTT for B2: 2 entries
0     ((&amp; B2::vtable for B2) + 24)
8     ((&amp; B2::vtable for B2) + 80)

Class B2
   size=32 align=8
   base size=13 base align=8
B2 (0x0x7ffad8f8fc30) 0
    vptridx=0 vptr=((&amp; B2::vtable for B2) + 24)
  B (0x0x7ffad8f96b40) 16 virtual
      vptridx=8 vbaseoffset=-24 vptr=((&amp; B2::vtable for B2) + 80)

Vtable for D
D::vtable for D: 20 entries
0     40
8     (int (*)(...))0
16    (int (*)(...))(&amp; typeinfo for D)
24    (int (*)(...))D::f
32    (int (*)(...))D::f1
40    (int (*)(...))B1::Bf1
48    (int (*)(...))D::f2
56    (int (*)(...))D::Df
64    24
72    (int (*)(...))-16
80    (int (*)(...))(&amp; typeinfo for D)
88    (int (*)(...))D::non-virtual thunk to D::f()
96    (int (*)(...))D::non-virtual thunk to D::f2()
104   (int (*)(...))B2::Bf2
112   0
120   18446744073709551576      // -40
128   (int (*)(...))-40
136   (int (*)(...))(&amp; typeinfo for D)
144   (int (*)(...))D::virtual thunk to D::f()
152   (int (*)(...))B::Bf

VTT for D
D::VTT for D: 7 entries
0     ((&amp; D::vtable for D) + 24)
8     ((&amp; D::construction vtable for B1-in-D) + 24)
16    ((&amp; D::construction vtable for B1-in-D) + 80)
24    ((&amp; D::construction vtable for B2-in-D) + 24)
32    ((&amp; D::construction vtable for B2-in-D) + 80)
40    ((&amp; D::vtable for D) + 144)
48    ((&amp; D::vtable for D) + 88)

Class D
   size=56 align=8
   base size=37 base align=8
D (0x0x7ffad8fc0150) 0
    vptridx=0 vptr=((&amp; D::vtable for D) + 24)
  B1 (0x0x7ffad8f8fd00) 0
      primary-for D (0x0x7ffad8fc0150)
      subvttidx=8
    B (0x0x7ffad8f96ea0) 40 virtual
        vptridx=40 vbaseoffset=-24 vptr=((&amp; D::vtable for D) + 144)
  B2 (0x0x7ffad8f8fd68) 16
      subvttidx=24 vptridx=48 vptr=((&amp; D::vtable for D) + 88)
    B (0x0x7ffad8f96ea0) alternative-path
</code></pre>
<h3 id="è™šå•ç»§æ‰¿">è™šå•ç»§æ‰¿</h3>
<p>æš‚æ—¶æŠ›å¼€å…¶ä»–éƒ¨åˆ†ï¼Œåªå…³æ³¨<code>B-&gt;B1</code>è¿™ä¸€æ¡å•ç»§æ‰¿&amp;è™šç»§æ‰¿çš„ç»“æ„ã€‚å¯ä»¥å‘ç°ç›¸æ¯”äºæ™®é€šçš„å•ç»§æ‰¿ï¼Œ<code>B1</code>çš„è™šè¡¨çš„æ¯ä¸€æ®µå¼€å¤´éƒ½æ–°å¢äº†ä¸€é¡¹ <code>16</code>ï¼Œè€Œä¸”ç»§æ‰¿ç±»çš„è™šè¡¨ä¸å†æ˜¯é‡å åœ¨åŸºç±»çš„è™šè¡¨ä¸Šã€‚é‚£ä¹ˆè™šç»§æ‰¿ä¸ºä»€ä¹ˆè¦ç»™è™šè¡¨æ–°å¢ä¸€é¡¹ï¼Ÿä¸ºä»€ä¹ˆæœ¬ç±»çš„è™šå‡½æ•°æ²¡æœ‰è¿½åŠ åˆ°åŸºç±»çš„è™šè¡¨å°¾éƒ¨ï¼Œè€Œæ˜¯ç‹¬ç«‹ä¸€å—ï¼Ÿ</p>
<p>é¦–å…ˆæˆ‘ä»¬çŸ¥é“è™šç»§æ‰¿çš„ä½œç”¨æ˜¯ä½¿å¾—åœ¨é’»çŸ³å‹ç»§æ‰¿å±‚æ¬¡ä¸‹ï¼ˆè¯´æ™®éä¸€ç‚¹åº”è¯¥æ˜¯å…±åŸºç±»å¤šç»§æ‰¿ï¼‰ï¼Œåº•å±‚æ´¾ç”Ÿç±»ä¸­åªå­˜åœ¨ä¸€ä¸ªè™šåŸºç±»å­å¯¹è±¡ã€‚å¦‚æœå­ç±»ç›´æ¥ä½¿ç”¨<code>this</code>æŒ‡é’ˆåŠ ä¸Šä¸€ä¸ªå›ºå®šçš„åç§»å»è®¿é—®è™šåŸºç±»ä¸­çš„æˆå‘˜çš„è¯ï¼Œè™šåŸºç±»å­å¯¹è±¡çš„ä½ç½®å°±ä¼šè¢«å›ºå®šä¸‹æ¥ï¼Œå¤šä¸ªå­ç±»å°±ä¸€å®šä¼šå¸¦ä¸Šå¤šä¸ªåŸºç±»å­å¯¹è±¡ã€‚è¿™ä¸è™šç»§æ‰¿çš„åŠŸèƒ½æ˜¯ç›¸è¿èƒŒçš„ã€‚</p>
<p>æ‰€ä»¥è™šåŸºç±»å­å¯¹è±¡çš„ä½ç½®ä¸èƒ½å›ºå®šã€‚é€šè¿‡<code>gdb</code>è°ƒè¯•ä¿¡æ¯å¯çŸ¥ï¼Œè™šåŸºç±»å­å¯¹è±¡ä¸€èˆ¬æ˜¯æ”¾åœ¨å­ç±»å¯¹è±¡çš„æœ«å°¾ã€‚ç±»<code>B</code>å­å¯¹è±¡åˆ°ç±»<code>B1</code>å­å¯¹è±¡ä¹‹é—´çš„è·ç¦»ç¡®å®ä¸æ˜¯å›ºå®šçš„ï¼ˆç±»<code>D</code>è¿˜å¯ä»¥ç»§æ‰¿æ›´å¤šç±»ï¼‰ã€‚æ‰§è¡Œä¸€ä¸ªæŒ‡å‘<code>D</code>å¯¹è±¡çš„<code>B1</code>æŒ‡é’ˆè°ƒç”¨çš„<code>B1</code>ä¸­æ²¡æœ‰è¢«<code>D</code>é‡å†™çš„è™šå‡½æ•°æ—¶ï¼ˆæ¯”å¦‚è¿™é‡Œçš„<code>b1_ptr-&gt;Bf();</code>ï¼‰ï¼Œéœ€è¦åŠ¨æ€åœ°ç¡®å®šåŸºç±»å­å¯¹è±¡çš„ä½ç½®ã€‚</p>
<pre><code class="language-c++">
(gdb) x/7xg &amp;d
0x7ffffffede20: 0x0000000008202b40      0x00000042000000b1      // vptr for B1 , {'B', 0xB1}
0x7ffffffede30: 0x0000000008202b80      0x00000043000000b2      // vptr for B2 , {'C', 0xB2}
0x7ffffffede40: 0x00000044000000dd      0x0000000008202bb8      // {'D', 0xDD} , vptr for B 
0x7ffffffede50: 0x00007f41000000bb                              // {'A', 0xBB}
...
(gdb) x/4xg &amp;b1
0x7ffffffede00: 0x0000000008202c68      0x00000042000000b1      // vptr for B1 , {'B', 0xB1}
0x7ffffffede10: 0x0000000008202ca0      0x00000041000000bb      // vptr for B  , {'A', 0xBB}
</code></pre>
<p>å› æ­¤éœ€è¦åœ¨è™šè¡¨ä¸­æ–°å¢ä¸€é¡¹ï¼Œç”¨äºæŒ‡å‡ºå¯¹è±¡ä¸­çš„è™šåŸºç±»å­å¯¹è±¡ç›¸å¯¹äºå½“å‰<code>this</code>æŒ‡é’ˆçš„åç§»å€¼ã€‚æ¯æ¬¡è®¿é—®è™šåŸºç±»çš„æˆå‘˜æ—¶éƒ½éœ€è¦å…ˆè¯»å–è¯¥å€¼ï¼Œå†å°†<code>this</code>åŠ ä¸Šæ­¤åç§»æ‰èƒ½å¾—åˆ°è™šåŸºç±»å­å¯¹è±¡çš„åœ°å€ã€‚</p>
<p>ä»¥<a href="https://godbolt.org/z/Ntzexw"><code>B1::f1()</code></a>ä¸­çš„ <code>--cb;</code> è¿™æ¡è¯­å¥ä¸ºä¾‹ï¼š</p>
<pre><code>...
mov     QWORD PTR [rbp-8], rdi
mov     rax, QWORD PTR [rbp-8]      // this -&gt; rax
mov     rax, QWORD PTR [rax]        // è™šè¡¨åœ°å€(é¦–è™šå‡½æ•°é¡¹åœ°å€) -&gt; rax
sub     rax, 24                     // å‘ä¸Šå¯» 3 ä¸ªè™šè¡¨é¡¹
mov     rax, QWORD PTR [rax]        // å–å¾—åˆ°è™šåŸºç±»å­å¯¹è±¡çš„åç§»å€¼
mov     rdx, rax                    // rax -&gt; rdx
mov     rax, QWORD PTR [rbp-8]      // this -&gt; rax
add     rax, rdx                    // è™šåŸºç±»å­å¯¹è±¡åœ°å€ = this + åç§»å€¼
movzx   edx, BYTE PTR [rax+12]      // å­å¯¹è±¡åœ°å€ + 12 å³ä¸º B::cb çš„åœ°å€
sub     edx, 1                      // --cb;
mov     BYTE PTR [rax+12], dl       // å¯„å­˜å™¨ -&gt; å†…å­˜
...
</code></pre>
<p>è¿™å°±æ˜¯è™šåŸºç±»å¸¦æ¥çš„è¿è¡Œæ—¶æ€§èƒ½æŸå¤±ã€‚ä»¥åŠè™šå‡½æ•°è¡¨çš„ä½œç”¨ä¹‹äºŒï¼Œå®šä½è™šåŸºç±»å­å¯¹è±¡çš„åœ°å€ã€‚</p>
<p>åŒæ—¶è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆè™šç»§æ‰¿ä¼šä½¿å¾—ç»§æ‰¿ç±»çš„è™šè¡¨ä¸­ï¼Œç»§æ‰¿ç±»è‡ªå·±ä½¿ç”¨çš„è™šå‡½æ•°ä¸å†å’ŒåŸºç±»ä½¿ç”¨çš„è™šå‡½æ•°é‡å åœ¨ä¸€èµ·ï¼Œä¸åƒæ™®é€šç»§æ‰¿é‡Œé‚£æ ·è¿½åŠ è¡¨é¡¹åˆ°åŸºç±»è™šè¡¨å°¾éƒ¨ã€‚è¿™æ˜¯å› ä¸ºç»§æ‰¿ç±»è®¿é—®ä»»ä½•è™šåŸºç±»çš„æˆå‘˜å˜é‡ï¼Œéƒ½éœ€è¦ç»è¿‡ç±»ä¼¼ä¸Šè¿°æ±‡ç¼–ä»£ç æ‰€è¿°çš„å°†<code>this</code>åŠ ä¸Šä¸€ä¸ªåç§»å€¼çš„è¿‡ç¨‹ï¼›è€Œè¿™ä¸ªåç§»å€¼ç›¸å¯¹<code>B1*</code>å’Œ<code>B*</code>æ˜¯ä¸ç›¸åŒçš„ï¼Œ<code>B1*</code>éœ€è¦åŠ ä¸Š<code>16</code>ï¼Œè€Œ<code>B*</code>åªéœ€åç§»<code>0</code>ï¼›æ‰€ä»¥ä¸¤è€…ä¸èƒ½å…±å¤„ï¼Œç»§æ‰¿ç±»å’Œè™šåŸºç±»ä¸å†å…±ç”¨åŒä¸€æ®µè™šè¡¨ã€‚åœ¨ç»§æ‰¿ç±»çš„è™šè¡¨çš„ä¸­é—´è¿˜æœ‰ä¸€é¡¹ä¸º<code>0</code>ï¼Œæˆ‘çŒœå°±æ˜¯ç”¨æ¥åˆ†éš”ä¸¤æ®µçš„ã€‚</p>
<p>è€Œè¿™æ ·çš„åˆ†ç¦»åˆå¯¼è‡´äº†å…¶ä»–åæœï¼Œä¸”çœ‹ä¸‹å›¾ï¼š<br>
<img src="https://yang2096.github.io/post-images/1629730306201.bmp" alt="" loading="lazy"></p>
<p>ä¸€ä¸ªæŒ‡å‘<code>B1</code>å¯¹è±¡çš„<code>B1*</code>ç±»å‹çš„æŒ‡é’ˆï¼Œè°ƒç”¨ç»§æ‰¿è€Œæ¥çš„è™šå‡½æ•°ï¼Œæ‰€éœ€è¦çš„æ­¥éª¤æ¯”å®ƒåŸºç±»çš„æŒ‡é’ˆè°ƒç”¨è¿™ä¸ªå‡½æ•°å¤šå‡ºè¿™ä¹ˆå¤šã€‚æ¥çœ‹çœ‹å®ƒå¤šå¹²äº†å“ªäº›æ´»ï¼š</p>
<pre><code class="language-asm">mov     rax, QWORD PTR [rbp-8]  \
mov     rax, QWORD PTR [rax]     |
sub     rax, 24                  |
mov     rax, QWORD PTR [rax]      } è™šåŸºç±»å­å¯¹è±¡åœ°å€ -&gt; rdx
mov     rdx, rax                 |
mov     rax, QWORD PTR [rbp-8]   |
add     rdx, rax                /
mov     rax, QWORD PTR [rbp-8]  \
mov     rax, QWORD PTR [rax]     |
sub     rax, 24                  |
mov     rax, QWORD PTR [rax]     |
mov     rcx, rax                 |
mov     rax, QWORD PTR [rbp-8]    } è™šåŸºç±»çš„ç¬¬äºŒä¸ªè™šå‡½æ•°åœ°å€ -&gt; rax
add     rax, rcx                 |
mov     rax, QWORD PTR [rax]     |
add     rax, 8                   |
mov     rax, QWORD PTR [rax]    /
mov     rdi, rdx
call    rax
</code></pre>
<p>å¯ä»¥çœ‹å‡ºæœ‰è™šç»§æ‰¿æ—¶ï¼Œæ²¡æœ‰é‡å†™çš„è™šå‡½æ•°éœ€è¦å…ˆå°†<code>B1 *this</code>è½¬æ¢æˆ<code>B *this</code>æ‰èƒ½è°ƒç”¨ã€‚å› ä¸º<code>B1</code>çš„è™šè¡¨ï¼ˆå‰ä¸€æ®µï¼‰é‡Œç¼ºå°‘å®ƒæ²¡æœ‰é‡å†™çš„è™šå‡½æ•°ï¼Œæƒ³è¦è°ƒç”¨åªèƒ½æ˜¯<code>B*</code>æ¥è°ƒç”¨ã€‚å¯ä»¥è¯´æ˜¯è™šå‡½æ•°è°ƒç”¨ä¸­æœ€ç¹ççš„ä¸€ç±»è°ƒç”¨æ–¹å¼äº†ã€‚ï¼ˆè¿™é‡Œå±…ç„¶é‡å¤è®¡ç®—äº†è™šåŸºç±»å­å¯¹è±¡çš„åœ°å€ğŸ˜³ã€‚ä¸è¿‡è¿™åªæ˜¯<code>g++</code>çš„ä¸€å®¶ä¹‹è¨€ï¼Œç†è§£å°±å¥½ã€‚ï¼‰</p>
<h3 id="é’»çŸ³è™šç»§æ‰¿">é’»çŸ³è™šç»§æ‰¿</h3>
<p>åœ¨æ²¡æœ‰å¼•å…¥è™šç»§æ‰¿å‰ï¼Œç»§æ‰¿ä½“ç³»ä¸­çš„æ¯ä¸ªç±»åœ¨æ„é€ æ—¶åªéœ€è¦è°ƒç”¨å…¶ç›´æ¥åŸºç±»çš„æ„é€ å‡½æ•°å³å¯ã€‚åŸºç±»è‡ªç„¶ä¼šé€’å½’åœ°è°ƒç”¨å®ƒçš„åŸºç±»çš„æ„é€ å‡½æ•°ã€‚</p>
<p>è€Œå¼•å…¥è™šç»§æ‰¿åï¼Œè™šåŸºç±»çš„æ„é€ äº¤ç»™äº†ç»§æ‰¿ä½“ç³»ä¸­æœ€åº•å±‚çš„é‚£ä¸ªç±»ã€‚æ‰€ä»¥ä¸­é—´çš„é‚£äº›ç±»ï¼ˆæˆ–è€…è¯´æ¯ä¸€ä¸ªå«æœ‰è™šåŸºç±»çš„ç±»ï¼‰å¿…é¡»çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¸å»æ„é€ è‡ªå·±çš„è™šåŸºç±»ã€‚</p>
<p>å…·ä½“åˆ°è¿™ä¸ªä¾‹å­ï¼Œ<code>new</code>ä¸€ä¸ªç±»<code>D</code>çš„å¯¹è±¡æ—¶ï¼Œ<code>B</code>çš„æ„é€ å‡½æ•°åº”è¯¥ç”±<code>D</code>çš„æ„é€ å‡½æ•°è°ƒç”¨ã€‚ä¸­é—´çš„<code>B1</code>å’Œ<code>B2</code>ä¸èƒ½é‡å¤æ„é€ ç±»<code>B</code>ã€‚è€Œ<code>new</code>ä¸€ä¸ªç±»<code>B1</code>æ—¶ï¼Œå®ƒåˆéœ€è¦è‡ªå·±å»æ„é€ ç±»<code>B</code>äº†ã€‚ä¸ºäº†å¤„ç†ä¸¤ç§ä¸åŒçš„æ„é€ éœ€æ±‚â€”â€”åªæ„é€ è‡ªå·±å’ŒåŒæ—¶æ„é€ è™šåŸºç±»ä¸è‡ªå·±â€”â€”<code>g++</code>ä¸ºå«æœ‰è™šåŸºç±»çš„ç±»ç”Ÿæˆäº†ä¸¤ä¸ªä¸åŒçš„æ„é€ å‡½æ•°ï¼Œ<code>base object constructor</code>å’Œ<code>complete object constructor</code>ã€‚å‰è€…ä¸“ç”±è¯¥ç±»çš„æ´¾ç”Ÿç±»è°ƒç”¨ã€‚</p>
<p>è™šç»§æ‰¿çš„æ–°å¢çš„ä¸¤ä¸ªç»“æ„ <code>VTT</code> å’Œ <code>Construction vtable</code> æ­£æ˜¯ä¸ºäº†å¤„ç†è™šåŸºç±»çš„æ„é€ è¿‡ç¨‹è€Œå¼•å…¥çš„ã€‚</p>
<p><code>VTT</code>çš„æ„æ€æ˜¯<code>virtual-table table</code>ï¼Œç”¨æ¥ç´¢å¼•è™šè¡¨çš„è¡¨ï¼Œå…¶è¡¨é¡¹æŒ‡å‘äº†å„ä¸ªè™šè¡¨çš„ä¸åŒä½ç½®ã€‚</p>
<p><code>Construction vtable for xx-in-yy</code> é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸“é—¨ç»™ç±»<code>yy</code>åœ¨æ„é€ å…¶åŸºç±»<code>xx</code>æ—¶æ‰€ä½¿ç”¨çš„è™šè¡¨ã€‚</p>
<p>å…ˆçœ‹çœ‹åœ¨ç±»<code>D</code>çš„<code>complete object constructor</code>é‡Œè¿™ä¸¤ä¸ªç»“æ„å¦‚ä½•ä½¿ç”¨ï¼š</p>
<pre><code class="language-asm">mov     QWORD PTR [rbp-8], rdi
mov     rax, QWORD PTR [rbp-8]
add     rax, 40                                 // è™šåŸºç±»å­å¯¹è±¡åœ°å€
mov     rdi, rax
call    B::B() [base object constructor]        // æ„é€ ç±» B
mov     rax, QWORD PTR [rbp-8]
mov     edx, OFFSET FLAT:VTT for D+8            // VTT for D çš„ç¬¬äºŒé¡¹ï¼Œæ˜¯åœ°å€è€Œä¸æ˜¯å†…å®¹ï¼ˆæ„é€ è™šè¡¨ï¼‰
mov     rsi, rdx
mov     rdi, rax
call    B1::B1() [base object constructor]      // æ„é€ ç±» B1, ä½¿ç”¨çš„æ˜¯ base object constructor
mov     rax, QWORD PTR [rbp-8]
add     rax, 16
mov     edx, OFFSET FLAT:VTT for D+24           // VTT for D çš„ç¬¬å››é¡¹
mov     rsi, rdx
mov     rdi, rax
call    B2::B2() [base object constructor]      // æ„é€ ç±» B2
mov     edx, OFFSET FLAT:vtable for D+24        
mov     rax, QWORD PTR [rbp-8]
mov     QWORD PTR [rax], rdx                    // ç±» D ä¸­çš„ vptr for B1
mov     rax, QWORD PTR [rbp-8]
add     rax, 40
mov     edx, OFFSET FLAT:vtable for D+144       
mov     QWORD PTR [rax], rdx
mov     edx, OFFSET FLAT:vtable for D+88        // ç±» D ä¸­çš„ vptr for B
mov     rax, QWORD PTR [rbp-8]
mov     QWORD PTR [rax+16], rdx                 // ç±» D ä¸­çš„ vptr for B2
mov     rax, QWORD PTR [rbp-8]
mov     DWORD PTR [rax+32], 221                 // 0xDD
mov     rax, QWORD PTR [rbp-8]
mov     BYTE PTR [rax+36], 68                   // 'D'
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ç±» <code>D</code> åœ¨æ„é€  <code>B1</code> å’Œ <code>B2</code> çš„æ—¶å€™ä¸ä»…ä½¿ç”¨çš„æ˜¯ <code>base object constructor</code>ï¼Œè€Œä¸”è¿˜å°†<code>construction vtable</code>çš„ç´¢å¼•ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚é‚£ä¹ˆè¿™ä¸ªæ„é€ è™šè¡¨ä¸æ™®é€šè™šè¡¨åˆæœ‰ä½•ä¸åŒå‘¢ï¼Ÿ</p>
<p>ä¸ºäº†ä¾¿äºæ¯”è¾ƒï¼Œæˆ‘æŠŠ<code>Construction vtable for B1-in-D</code> æ”¾åˆ°äº† <code>Vtable for B1</code> çš„å³è¾¹ï¼Œå¯ä»¥çœ‹åˆ°æ„é€ è™šè¡¨ä¸­é™¤äº†è™šåŸºç±»çš„åç§»ä¸åŒï¼ˆä¸»è¦ä½œç”¨ï¼‰ä¹‹å¤–ï¼Œå…¶ä»–è¡¨é¡¹å…¨éƒ½ç›¸åŒï¼Œè¿™æ„å‘³ç€<code>B1</code>çš„æ„é€ å‡½æ•°ä¸­åªèƒ½ä½¿ç”¨è‡ªå·±çš„è™šå‡½æ•°ã€‚è¿™ä¹Ÿæ˜¯ã€ŠEffective C++ã€‹ä¸­æ¡æ¬¾9ï¼šâ€œç»ä¸åœ¨æ„é€ å’Œææ„å‡½æ•°ä¸­è°ƒç”¨ virtual å‡½æ•°â€çš„åŸå› ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™æ²¡æœ‰å¤šæ€ï¼Œè™šå‡½æ•°çš„è°ƒç”¨éƒ½æ˜¯å›ºå®šçš„ã€‚ä¸å¯èƒ½ä¹Ÿä¸å¯ä»¥åœ¨åŸºç±»çš„æ„é€ å‡½æ•°ä¸­è°ƒç”¨åˆ°æ´¾ç”Ÿç±»çš„è™šå‡½æ•°â€”â€”æ´¾ç”Ÿç±»çš„æˆå‘˜éƒ½è¿˜æ²¡æœ‰æ„é€ å¥½ã€‚å®é™…ä¸Šæ¡æ¬¾ 9 é’ˆå¯¹æ˜¯æ‰€æœ‰ç»§æ‰¿æ–¹å¼è€Œä¸åªæ˜¯è™šç»§æ‰¿ï¼Œåªæ˜¯ä¸æ„é€ è™šè¡¨ç»“åˆåˆ™æ›´ç°çªå‡ºã€‚</p>
<p>è‡³äº<code>VTT</code>çš„ä½œç”¨ï¼Œåœ¨è¿™ä¸ªç»§æ‰¿ä½“ç³»ä¸­çš„ä½œç”¨å…¶å®è¿˜ä¸å¤ªæ˜æ˜¾ï¼Œå®Œå…¨å¯ä»¥ç›´æ¥ä¼ é€’æ„é€ è™šè¡¨çš„åœ°å€ç»™<code>base object constructor</code>ã€‚<code>VTT</code>æœåŠ¡äºæ›´åŠ å¤šå±‚çš„ç»§æ‰¿ä½“ç³»ï¼Œå‡å¦‚åˆæœ‰ä¸€ä¸ªç±»<code>E</code>ç»§æ‰¿äº†ç±»<code>D</code>ï¼Œé‚£ä¹ˆåœ¨ç±»<code>D</code>çš„<code>base object constructor</code>ä¸­ï¼Œéœ€è¦ç±»<code>E</code>æä¾›çš„<code>Construction vtable for D-in-E</code> ä»¥åŠ <code>Construction vtable for B1-in-E</code>ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸èƒ½åªä¼ å…¥ä¸€ä¸ªæ„é€ è™šè¡¨çš„åœ°å€ï¼Œè€Œæ˜¯ä¼ å…¥<code>VTT</code>ä¸­çš„ç›¸åº”è¡¨é¡¹ï¼Œå°±å¯ä»¥è®©<code>D</code>çš„<code>base object constructor</code>è‡ªå·±åŠ ä¸Šåç§»æ‰¾åˆ°<code>Construction vtable for B1-in-E</code>å’Œ<code>Construction vtable for B2-in-E</code>äº†ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>é€šè¿‡åˆ†æç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§ç»“æ„ä»¥åŠå„ç±»è™šå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼Œå¯ä»¥è¾ƒä¸ºæ¸…æ¥šåœ°äº†è§£åˆ° C++ åº•å±‚å¯¹äºå¤šæ€æ€§çš„æ”¯æŒã€‚è€Œ C++ å¤šæ€æ€§çš„æœ€ä¸»è¦æ”¯æ’‘ç‚¹å°±æ˜¯è™šå‡½æ•°è¡¨ï¼Œå®ƒè§£å†³äº†ç±»å‹è¯†åˆ«ï¼Œå‡½æ•°å»¶è¿Ÿç»‘å®šï¼Œå…±æœ‰åŸºç±»å­å¯¹è±¡æŸ¥æ‰¾ç­‰é—®é¢˜ã€‚</p>
<p>æœ¬æ–‡ä»…åˆ†æäº†è™šå‡½æ•°è°ƒç”¨ä»¥åŠæ„é€ å‡½æ•°è°ƒç”¨çš„æƒ…å†µï¼Œå°šæœ‰<code>RTTI</code>åŠå¼‚å¸¸å¤„ç†ç­‰å¤šæ€æ€§çš„è¯­ä¹‰æœªæåŠã€‚æœ¬æ–‡çš„åˆ†æå¯¹è±¡ä»…é™äº<code>gcc version 7.5.0 (Ubuntu 7.5.0-3ubuntu1~18.04)</code>æ‰€ç”Ÿæˆçš„æ•°æ®ï¼Œå…¶ä»–ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç åˆ™å¤šæœ‰ä¸åŒï¼Œæ¯”å¦‚<code>MSVC</code>ä¸­å°±æ˜¯ç›´æ¥å°†è™šåŸºç±»å­å¯¹è±¡çš„åç§»æ’å…¥åˆ°äº†å¯¹è±¡å½“ä¸­ã€‚è¿™äº›éƒ½æœ‰å¾…ç»§ç»­æ¢ç´¢ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<p><a href="https://coolshell.cn/articles/12176.html">C++ å¯¹è±¡çš„å†…å­˜å¸ƒå±€ | | é…· å£³ - CoolShell</a><br>
<a href="https://shaharmike.com/cpp/vtable-part1/">C++ vtables - Part 1 - Basics | Shahar Mike's Web Spot</a><br>
<a href="https://www.cnblogs.com/BEN-LK/p/10720300.html">C++å¤šæ€åŠå…¶å®ç°åŸç†</a><br>
<a href="https://www.cnblogs.com/QG-whz/p/4909359.html">å›¾è¯´C++å¯¹è±¡æ¨¡å‹ï¼šå¯¹è±¡å†…å­˜å¸ƒå±€è¯¦è§£</a><br>
<a href="https://blog.csdn.net/xiejingfa/article/details/48028491">ä»å†…å­˜å¸ƒå±€çœ‹C++è™šç»§æ‰¿çš„å®ç°åŸç†_C/C++_ä¸Šå–„è‹¥æ°´ï¼Œäººæ·¡å¦‚èŠ-CSDNåšå®¢</a><br>
<a href="https://quuxplusone.github.io/blog/2019/09/30/what-is-the-vtt/">What is the virtual table table?</a></p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#c-%E5%A4%9A%E6%80%81%E7%9A%84%E5%BA%95%E5%B1%82%E6%94%AF%E6%8C%81">C++ å¤šæ€çš„åº•å±‚æ”¯æŒ</a></li>
<li><a href="#%E8%99%9A%E5%87%BD%E6%95%B0%E8%A1%A8%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84">è™šå‡½æ•°è¡¨çš„åŸºæœ¬ç»“æ„</a>
<ul>
<li><a href="#%E6%9C%80%E5%9F%BA%E7%A1%80%E7%9A%84%E6%83%85%E5%86%B5">æœ€åŸºç¡€çš„æƒ…å†µ</a>
<ul>
<li><a href="#%E8%99%9A%E8%A1%A8%E5%B8%83%E5%B1%80">è™šè¡¨å¸ƒå±€</a></li>
<li><a href="#%E8%99%9A%E8%A1%A8%E6%8C%87%E9%92%88%E5%88%9D%E8%AF%95%E9%94%8B%E8%8A%92">è™šè¡¨æŒ‡é’ˆåˆè¯•é”‹èŠ’</a></li>
</ul>
</li>
<li><a href="#%E5%A4%9A%E7%BB%A7%E6%89%BF%E7%9A%84%E6%83%85%E5%86%B5">å¤šç»§æ‰¿çš„æƒ…å†µ</a>
<ul>
<li><a href="#%E8%99%9A%E8%A1%A8%E5%B8%83%E5%B1%80-2">è™šè¡¨å¸ƒå±€</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%BC%95%E5%85%A5%E8%99%9A%E7%BB%A7%E6%89%BF%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%8F%98%E5%8C%96">å¼•å…¥è™šç»§æ‰¿å¸¦æ¥çš„å˜åŒ–</a>
<ul>
<li><a href="#%E8%99%9A%E5%8D%95%E7%BB%A7%E6%89%BF">è™šå•ç»§æ‰¿</a></li>
<li><a href="#%E9%92%BB%E7%9F%B3%E8%99%9A%E7%BB%A7%E6%89%BF">é’»çŸ³è™šç»§æ‰¿</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://yang2096.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
